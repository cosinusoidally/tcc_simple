rm -r artifacts/builds/hex2_test
set -xe
source common.sh

pushd .

mkdir artifacts/builds/hex2_test


gcc -O0 -g3 -m32 hex2_test.c -o artifacts/builds/hex2_test/hex2.exe

cd artifacts/builds/hex2_test
ls -lh

./hex2.exe ../m0_test/cjsawk.exe-0.hex2 cjsawk.exe
./hex2.exe ../m0_test/m0_self.exe-0.hex2 m0_self.exe

diff -u -s ../m0_test/cjsawk.exe cjsawk.exe
diff -u -s ../m0_test/m0_self.exe m0_self.exe

# prepare to build hex2.js with cjsawk
cat ../../../hex2.js ../../../support_libc.js ../../../simple_support_js_m2_prims.c ../../../support_m2.c > hex2_self.c

compile ./cjsawk.exe hex2_self.c hex2_self.exe

function compile_alt() {
  $1 $2 $3.M1
  cat ../../../../m2min_v3/simple_asm_defs.M1 ../../../../m2min_v3/x86_defs.M1 ../../../../m2min_v3/libc-core.M1 $3.M1 > $3-0.M1
  ./m0_self$4.exe $3-0.M1 $3.hex2
  cat ../../../../m2min_v3/ELF-i386.hex2 $3.hex2 > $3-0.hex2
  ./hex2_self$4.exe $3-0.hex2 $3
# hack since chmod is not implemented yet in C support code
  chmod +x $3
}


compile_alt ./cjsawk.exe ../../deps/cjsawk_full.c cjsawk2.exe
compile_alt ./cjsawk2.exe ../m0_test/m0_self.c m0_self2.exe
compile_alt ./cjsawk2.exe ./hex2_self.c hex2_self2.exe

compile_alt ./cjsawk2.exe ../../deps/cjsawk_full.c cjsawk3.exe 2
compile_alt ./cjsawk3.exe ../m0_test/m0_self.c m0_self3.exe 2
compile_alt ./cjsawk3.exe ./hex2_self.c hex2_self3.exe 2

shasum *exe | sort

popd

wc hex2.js hex2.c hex2_orig.c

echo "DONE hex2_test"
